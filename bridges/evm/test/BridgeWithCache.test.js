const { expectRevert } = require("openzeppelin-test-helpers");
const CacheBridge = artifacts.require("CacheBridge");
const BridgeCacheConsumerMock = artifacts.require("BridgeCacheConsumerMock");

require("chai").should();

contract("CacheBridge", ([_, owner, alice, bob]) => {
  context(
    "Checking oracle state relaying and consumtion  (4 validators)",
    () => {
      beforeEach(async () => {
        this.template = [
          "from_scan",
          "1",
          "0x000000034254430000000000000064",
          "4",
          "4",
        ];
        this.cache = await CacheBridge.new(
          [
            ["0x652D89a66Eb4eA55366c45b1f9ACfc8e2179E1c5", 100],
            ["0x88e1cd00710495EEB93D4f522d16bC8B87Cb00FE", 100],
            ["0xaAA22E077492CbaD414098EBD98AA8dc1C7AE8D9", 100],
            ["0xB956589b6fC5523eeD0d9eEcfF06262Ce84ff260", 100],
          ],
          { from: owner },
        );

        this.consumer = await BridgeCacheConsumerMock.new(
          this.cache.address,
          this.template,
          { from: alice },
        );
      });

      it("should get correct configs from the consumer", async () => {
        (await this.consumer.bridgeCache())
          .toString()
          .should.eq(this.cache.address.toString());

        const {
          clientId,
          oracleScriptId,
          params,
          askCount,
          minCount,
        } = await this.consumer.requestTemplate();

        [
          clientId,
          oracleScriptId.toString(),
          params,
          askCount.toString(),
          minCount.toString(),
        ]
          .toString()
          .should.eq(this.template.toString());
      });

      it("should be able relay and get response from state", async () => {
        await expectRevert(
          this.cache.getLatestResponse(this.template),
          "RESPONSE_NOT_FOUND",
        );

        await this.cache.relay(
          "0x0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000005e00000000000000000000000000000000000000000000000000000000000000a0e5b14e631db5cdbb2c068be853242e45a091e9c178a5ca180656a12f6afde184472628869fbd308d01fcbd3411df82b10329b57df6c0c44626024e1bb0465b9486fdb04f6871c5d4bd5cb74a4c5a13a537bdd1159f7c38e797d297bc5f19770fbb1f2fd852e790e735ca2d3014f96a2a53c60393e9c6bbf941b9a6dd6a05cf6f97e9cc402179a6714d7a4e34d8ddd21e853780a131455be3cdf89760b972c4b2532fa694879095840619f5e49380612bd296ff7e950eafb66ff654d99ca70869ef5529da80f2d395d551db9bce5ae15f89dd95314ca25124ec2456cf273c56fccd44c55c16e5d04367ddc30ca19f062d7bcd995c66a9f7b7437044391946ff1aa004209a161040ab1778e2f2c00ee482f205b28efba439fcb04ea283f619478d96e340b9cffb37a989ca544e6bb780a2c78901d3fb33738768511a30617afa01d7f4be7e5a1eb872ad44103360ddc190410331280c42a54d829a5d752c796685d00000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000002e05625b835f405a26be5befe6f5f84e3078e8c4776ad18f98e746878b6770749ed44096ce96669a26351476f69665ba7ecc86372625a51fe5e6c49a8bd509169f7000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802110e0a00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a20bc2ee65d649f9ac73b1c9da9af321df3058202a8873f4547bb1558ac6e39201810012a0c08f295c8f7051090ab958701320962616e64636861696e004add47680935a19b6ec9cedd40423b6729bc989de76cfc6debe51bb5be9735c8278a48fb4cd26f8b3735646a6bd4d234c459b8e6e1543b21ef324d0d3f80999c000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802110e0a00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a20bc2ee65d649f9ac73b1c9da9af321df3058202a8873f4547bb1558ac6e39201810012a0c08f295c8f70510b5c9938301320962616e64636861696e003892a4f6e094129190e9a6626de612731333b1efd797efe3325903e63508624073f41504a93434ac2ca26e93d5a32ab40edbb870711992f20621b7d6a2f54335000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802110e0a00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a20bc2ee65d649f9ac73b1c9da9af321df3058202a8873f4547bb1558ac6e39201810012a0c08f295c8f70510c2edf88301320962616e64636861696e0000000000000000000000000000000000000000000000000000000000000007a00000000000000000000000000000000000000000000000000000000000000a0e00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000007ea000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000966726f6d5f7363616e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f000000034254430000000000000064000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000005ef20816000000000000000000000000000000000000000000000000000000005ef2081a00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000966726f6d5f7363616e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000eb71b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000009b27e34da46bfd69cee4ffcbb512395fa7fa5fc7d5016aabe242f8e99cb82e806af00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000009b2bbd0ad34229408383dc3e8f4eaa1c44481ae7198a8ad5dfa234ed0559f09183c00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000009c3d15486b84f62b5535c0fd46c437489d212911d95501211f1c3a730e32f630eb600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000d00000000000000000000000000000000000000000000000000000000000009c33cdb5cc721bc11d70d6eb33377a26c387ef3c45c064916d6a36659402252ff5600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001b00000000000000000000000000000000000000000000000000000000000009c3121889d461b385a0d77fa5e484f58ad580f126d307526e7ef487c6742a8da9d900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000009c3562e86bb47132ccc0223eea4c35ef16d0d512086a975f1b473706dd23a5713540000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000a0d0920a260853246a4ffb39a139a1ac98e3590879f521e03514a38448107996c50",
          { from: bob },
        );

        const {
          clientId,
          requestId,
          ansCount,
          requestTime,
          resolveTime,
          resolveStatus,
          result,
        } = await this.cache.getLatestResponse(this.template);

        [
          clientId,
          requestId,
          ansCount,
          requestTime,
          resolveTime,
          resolveStatus,
          result,
        ]
          .toString()
          .should.eq(
            [
              "from_scan",
              "3",
              "4",
              "1592920086",
              "1592920090",
              "1",
              "0x00000000000eb71b",
            ].toString(),
          );
      });

      it("should be able relay and update the state", async () => {
        await expectRevert(
          this.cache.getLatestResponse(this.template),
          "RESPONSE_NOT_FOUND",
        );

        // initial relay
        await this.cache.relay(
          "0x0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000005e00000000000000000000000000000000000000000000000000000000000000a0e5b14e631db5cdbb2c068be853242e45a091e9c178a5ca180656a12f6afde184472628869fbd308d01fcbd3411df82b10329b57df6c0c44626024e1bb0465b9486fdb04f6871c5d4bd5cb74a4c5a13a537bdd1159f7c38e797d297bc5f19770fbb1f2fd852e790e735ca2d3014f96a2a53c60393e9c6bbf941b9a6dd6a05cf6f97e9cc402179a6714d7a4e34d8ddd21e853780a131455be3cdf89760b972c4b2532fa694879095840619f5e49380612bd296ff7e950eafb66ff654d99ca70869ef5529da80f2d395d551db9bce5ae15f89dd95314ca25124ec2456cf273c56fccd44c55c16e5d04367ddc30ca19f062d7bcd995c66a9f7b7437044391946ff1aa004209a161040ab1778e2f2c00ee482f205b28efba439fcb04ea283f619478d96e340b9cffb37a989ca544e6bb780a2c78901d3fb33738768511a30617afa01d7f4be7e5a1eb872ad44103360ddc190410331280c42a54d829a5d752c796685d00000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000002e05625b835f405a26be5befe6f5f84e3078e8c4776ad18f98e746878b6770749ed44096ce96669a26351476f69665ba7ecc86372625a51fe5e6c49a8bd509169f7000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802110e0a00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a20bc2ee65d649f9ac73b1c9da9af321df3058202a8873f4547bb1558ac6e39201810012a0c08f295c8f7051090ab958701320962616e64636861696e004add47680935a19b6ec9cedd40423b6729bc989de76cfc6debe51bb5be9735c8278a48fb4cd26f8b3735646a6bd4d234c459b8e6e1543b21ef324d0d3f80999c000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802110e0a00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a20bc2ee65d649f9ac73b1c9da9af321df3058202a8873f4547bb1558ac6e39201810012a0c08f295c8f70510b5c9938301320962616e64636861696e003892a4f6e094129190e9a6626de612731333b1efd797efe3325903e63508624073f41504a93434ac2ca26e93d5a32ab40edbb870711992f20621b7d6a2f54335000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802110e0a00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a20bc2ee65d649f9ac73b1c9da9af321df3058202a8873f4547bb1558ac6e39201810012a0c08f295c8f70510c2edf88301320962616e64636861696e0000000000000000000000000000000000000000000000000000000000000007a00000000000000000000000000000000000000000000000000000000000000a0e00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000007ea000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000966726f6d5f7363616e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f000000034254430000000000000064000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000005ef20816000000000000000000000000000000000000000000000000000000005ef2081a00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000966726f6d5f7363616e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000eb71b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000009b27e34da46bfd69cee4ffcbb512395fa7fa5fc7d5016aabe242f8e99cb82e806af00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000009b2bbd0ad34229408383dc3e8f4eaa1c44481ae7198a8ad5dfa234ed0559f09183c00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000009c3d15486b84f62b5535c0fd46c437489d212911d95501211f1c3a730e32f630eb600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000d00000000000000000000000000000000000000000000000000000000000009c33cdb5cc721bc11d70d6eb33377a26c387ef3c45c064916d6a36659402252ff5600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001b00000000000000000000000000000000000000000000000000000000000009c3121889d461b385a0d77fa5e484f58ad580f126d307526e7ef487c6742a8da9d900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000009c3562e86bb47132ccc0223eea4c35ef16d0d512086a975f1b473706dd23a5713540000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000a0d0920a260853246a4ffb39a139a1ac98e3590879f521e03514a38448107996c50",
          { from: bob },
        );

        // relay to update
        await this.cache.relay(
          "0x0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000005e00000000000000000000000000000000000000000000000000000000000000a4f2fb6b7c75032af08bb37d3df59722d54f400bec1f9f14bf840e7711cfc95e12b8e5deda960b2dc8f53406382441e13fc0821322c2b3dae3d8bbb5a4c6326ef087c80a176184bffaf33dcb3618c15e3371727c5b047598647ca3f9aecc4bd305cb1f2fd852e790e735ca2d3014f96a2a53c60393e9c6bbf941b9a6dd6a05cf6f995e24c5fd917b4277cfac3e06fde09ae89231b58b1db51dc69f57b98ec18d9e732fa694879095840619f5e49380612bd296ff7e950eafb66ff654d99ca70869e4c68ced6b571ac169f65570fd568a2bf2821ca8880ec1d7b1b8052beb3bb4adf15798391d1c7d642e97b1a8fd91c11ab50cb91aa780a859fc5d62ca96c338602004209a161040ab1778e2f2c00ee482f205b28efba439fcb04ea283f619478d96e340b9cffb37a989ca544e6bb780a2c78901d3fb33738768511a30617afa01dd991da4d4e69473cc75a4b819f9e07d4956671a6f4a74df4cc16596fcbe6813700000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000002e01297951f2c4fb97690848ce759ce1ab8ad8d972a951a869818828663159a8a6f0871114919ac2b6882b26da7728dd52d150ade92c4f6bca45791f005eb1bbbfe000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802114f0a00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a203a69db2cf26a980e8f51b3fcb05662eb72389ba98b5a6eec7ab7d51d18f8f04d10012a0c08c896c8f70510b39089e702320962616e64636861696e00d9efd0734b37e70e917d92c83e9b3ec9ab1cd3b1b5c91147310588bae960d25c2c85bb019f10afb9d2062ff880f0fca633a31e9e191f17c33006233281b13185000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802114f0a00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a203a69db2cf26a980e8f51b3fcb05662eb72389ba98b5a6eec7ab7d51d18f8f04d10012a0c08c896c8f7051086f3c0e602320962616e64636861696e0026be63ade11a107dbef75d5e506f1c64173d8bf1d9508bba19b74d7da222df561d1a861a5541af331fb13a5def77e5c3fbfe70378b134292f5380854817a9e9c000000000000000000000000000000000000000000000000000000000000001b00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802114f0a00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a203a69db2cf26a980e8f51b3fcb05662eb72389ba98b5a6eec7ab7d51d18f8f04d10012a0c08c896c8f7051094b592e602320962616e64636861696e0000000000000000000000000000000000000000000000000000000000000007a00000000000000000000000000000000000000000000000000000000000000a4f00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000009b2000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000966726f6d5f7363616e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f000000034254430000000000000064000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000005ef20a73000000000000000000000000000000000000000000000000000000005ef20a7700000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000966726f6d5f7363616e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000eb4bf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000009b2680ad6cf6e554cee42ff66ecbd120e66009b10284cabc5e02241552c818aae7d00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000009b2bbd0ad34229408383dc3e8f4eaa1c44481ae7198a8ad5dfa234ed0559f09183c00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000009c3d15486b84f62b5535c0fd46c437489d212911d95501211f1c3a730e32f630eb600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000d00000000000000000000000000000000000000000000000000000000000009c33cdb5cc721bc11d70d6eb33377a26c387ef3c45c064916d6a36659402252ff5600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001b00000000000000000000000000000000000000000000000000000000000009c3121889d461b385a0d77fa5e484f58ad580f126d307526e7ef487c6742a8da9d900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000009c3562e86bb47132ccc0223eea4c35ef16d0d512086a975f1b473706dd23a5713540000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000a4e240608de388ec1d1100d05d87f2766cc22f98376f955791546074aa8ae6b6d8e",
          { from: bob },
        );

        const {
          clientId,
          requestId,
          ansCount,
          requestTime,
          resolveTime,
          resolveStatus,
          result,
        } = await this.cache.getLatestResponse(this.template);

        [
          clientId,
          requestId,
          ansCount,
          requestTime,
          resolveTime,
          resolveStatus,
          result,
        ]
          .toString()
          .should.eq(
            [
              "from_scan",
              "4",
              "4",
              "1592920691",
              "1592920695",
              "1",
              "0x00000000000eb4bf",
            ].toString(),
          );
      });

      it("should not be able to submit old request", async () => {
        await expectRevert(
          this.cache.getLatestResponse(this.template),
          "RESPONSE_NOT_FOUND",
        );

        // initial relay
        await this.cache.relay(
          "0x0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000005e00000000000000000000000000000000000000000000000000000000000000a4f2fb6b7c75032af08bb37d3df59722d54f400bec1f9f14bf840e7711cfc95e12b8e5deda960b2dc8f53406382441e13fc0821322c2b3dae3d8bbb5a4c6326ef087c80a176184bffaf33dcb3618c15e3371727c5b047598647ca3f9aecc4bd305cb1f2fd852e790e735ca2d3014f96a2a53c60393e9c6bbf941b9a6dd6a05cf6f995e24c5fd917b4277cfac3e06fde09ae89231b58b1db51dc69f57b98ec18d9e732fa694879095840619f5e49380612bd296ff7e950eafb66ff654d99ca70869e4c68ced6b571ac169f65570fd568a2bf2821ca8880ec1d7b1b8052beb3bb4adf15798391d1c7d642e97b1a8fd91c11ab50cb91aa780a859fc5d62ca96c338602004209a161040ab1778e2f2c00ee482f205b28efba439fcb04ea283f619478d96e340b9cffb37a989ca544e6bb780a2c78901d3fb33738768511a30617afa01dd991da4d4e69473cc75a4b819f9e07d4956671a6f4a74df4cc16596fcbe6813700000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000002e01297951f2c4fb97690848ce759ce1ab8ad8d972a951a869818828663159a8a6f0871114919ac2b6882b26da7728dd52d150ade92c4f6bca45791f005eb1bbbfe000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802114f0a00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a203a69db2cf26a980e8f51b3fcb05662eb72389ba98b5a6eec7ab7d51d18f8f04d10012a0c08c896c8f70510b39089e702320962616e64636861696e00d9efd0734b37e70e917d92c83e9b3ec9ab1cd3b1b5c91147310588bae960d25c2c85bb019f10afb9d2062ff880f0fca633a31e9e191f17c33006233281b13185000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802114f0a00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a203a69db2cf26a980e8f51b3fcb05662eb72389ba98b5a6eec7ab7d51d18f8f04d10012a0c08c896c8f7051086f3c0e602320962616e64636861696e0026be63ade11a107dbef75d5e506f1c64173d8bf1d9508bba19b74d7da222df561d1a861a5541af331fb13a5def77e5c3fbfe70378b134292f5380854817a9e9c000000000000000000000000000000000000000000000000000000000000001b00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802114f0a00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a203a69db2cf26a980e8f51b3fcb05662eb72389ba98b5a6eec7ab7d51d18f8f04d10012a0c08c896c8f7051094b592e602320962616e64636861696e0000000000000000000000000000000000000000000000000000000000000007a00000000000000000000000000000000000000000000000000000000000000a4f00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000009b2000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000966726f6d5f7363616e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f000000034254430000000000000064000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000005ef20a73000000000000000000000000000000000000000000000000000000005ef20a7700000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000966726f6d5f7363616e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000eb4bf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000009b2680ad6cf6e554cee42ff66ecbd120e66009b10284cabc5e02241552c818aae7d00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000009b2bbd0ad34229408383dc3e8f4eaa1c44481ae7198a8ad5dfa234ed0559f09183c00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000009c3d15486b84f62b5535c0fd46c437489d212911d95501211f1c3a730e32f630eb600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000d00000000000000000000000000000000000000000000000000000000000009c33cdb5cc721bc11d70d6eb33377a26c387ef3c45c064916d6a36659402252ff5600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001b00000000000000000000000000000000000000000000000000000000000009c3121889d461b385a0d77fa5e484f58ad580f126d307526e7ef487c6742a8da9d900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000009c3562e86bb47132ccc0223eea4c35ef16d0d512086a975f1b473706dd23a5713540000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000a4e240608de388ec1d1100d05d87f2766cc22f98376f955791546074aa8ae6b6d8e",
          { from: bob },
        );

        // relay an older request
        await expectRevert(
          this.cache.relay(
            "0x0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000005e00000000000000000000000000000000000000000000000000000000000000a0e5b14e631db5cdbb2c068be853242e45a091e9c178a5ca180656a12f6afde184472628869fbd308d01fcbd3411df82b10329b57df6c0c44626024e1bb0465b9486fdb04f6871c5d4bd5cb74a4c5a13a537bdd1159f7c38e797d297bc5f19770fbb1f2fd852e790e735ca2d3014f96a2a53c60393e9c6bbf941b9a6dd6a05cf6f97e9cc402179a6714d7a4e34d8ddd21e853780a131455be3cdf89760b972c4b2532fa694879095840619f5e49380612bd296ff7e950eafb66ff654d99ca70869ef5529da80f2d395d551db9bce5ae15f89dd95314ca25124ec2456cf273c56fccd44c55c16e5d04367ddc30ca19f062d7bcd995c66a9f7b7437044391946ff1aa004209a161040ab1778e2f2c00ee482f205b28efba439fcb04ea283f619478d96e340b9cffb37a989ca544e6bb780a2c78901d3fb33738768511a30617afa01d7f4be7e5a1eb872ad44103360ddc190410331280c42a54d829a5d752c796685d00000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000002e05625b835f405a26be5befe6f5f84e3078e8c4776ad18f98e746878b6770749ed44096ce96669a26351476f69665ba7ecc86372625a51fe5e6c49a8bd509169f7000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802110e0a00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a20bc2ee65d649f9ac73b1c9da9af321df3058202a8873f4547bb1558ac6e39201810012a0c08f295c8f7051090ab958701320962616e64636861696e004add47680935a19b6ec9cedd40423b6729bc989de76cfc6debe51bb5be9735c8278a48fb4cd26f8b3735646a6bd4d234c459b8e6e1543b21ef324d0d3f80999c000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802110e0a00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a20bc2ee65d649f9ac73b1c9da9af321df3058202a8873f4547bb1558ac6e39201810012a0c08f295c8f70510b5c9938301320962616e64636861696e003892a4f6e094129190e9a6626de612731333b1efd797efe3325903e63508624073f41504a93434ac2ca26e93d5a32ab40edbb870711992f20621b7d6a2f54335000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802110e0a00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a20bc2ee65d649f9ac73b1c9da9af321df3058202a8873f4547bb1558ac6e39201810012a0c08f295c8f70510c2edf88301320962616e64636861696e0000000000000000000000000000000000000000000000000000000000000007a00000000000000000000000000000000000000000000000000000000000000a0e00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000007ea000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000966726f6d5f7363616e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f000000034254430000000000000064000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000005ef20816000000000000000000000000000000000000000000000000000000005ef2081a00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000966726f6d5f7363616e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000eb71b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000009b27e34da46bfd69cee4ffcbb512395fa7fa5fc7d5016aabe242f8e99cb82e806af00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000009b2bbd0ad34229408383dc3e8f4eaa1c44481ae7198a8ad5dfa234ed0559f09183c00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000009c3d15486b84f62b5535c0fd46c437489d212911d95501211f1c3a730e32f630eb600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000d00000000000000000000000000000000000000000000000000000000000009c33cdb5cc721bc11d70d6eb33377a26c387ef3c45c064916d6a36659402252ff5600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001b00000000000000000000000000000000000000000000000000000000000009c3121889d461b385a0d77fa5e484f58ad580f126d307526e7ef487c6742a8da9d900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000009c3562e86bb47132ccc0223eea4c35ef16d0d512086a975f1b473706dd23a5713540000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000a0d0920a260853246a4ffb39a139a1ac98e3590879f521e03514a38448107996c50",
            { from: bob },
          ),
          "FAIL_LATEST_REQUEST_SHOULD_BE_NEWEST",
        );
      });

      it("should not be able to submit an unresolved request", async () => {
        await expectRevert(
          this.cache.getLatestResponse(this.template),
          "RESPONSE_NOT_FOUND",
        );

        // relay a request with resolve status = 2
        await expectRevert(
          this.cache.relay(
            "0x0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000005e00000000000000000000000000000000000000000000000000000000000019e8c10d1bb5a23a0ed3668df0b2a4257b46225db7391c56e940ad95536d0e5a75d79f4be0eeff9a2e52e11da7591c029cee08ecfe59435dbd731679905a94c2bb53b8fdacf87d1d46d85ee2585ca5a304a2a499080b8c7460f5efac7d053911fbee6b1f2fd852e790e735ca2d3014f96a2a53c60393e9c6bbf941b9a6dd6a05cf6f9df898ce21b5981ca9994759bb2b77204496e9d062a080b52c2b38b8d8df0f55232fa694879095840619f5e49380612bd296ff7e950eafb66ff654d99ca70869e8f7beb334b2ff0c5c176144edbbfe9426cdb41fea466d43d0b89e2515f9e5a5170e961a346803fa2198490f4ded2683e31384b2a37725e719ae7ca164eb22ceb004209a161040ab1778e2f2c00ee482f205b28efba439fcb04ea283f619478d96e340b9cffb37a989ca544e6bb780a2c78901d3fb33738768511a30617afa01d0efe3e12f46363c7779140d4ce659925db52f19053e114d7cc4efd666b37f79f00000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000002e04ed98be18e8daa17dface914d1a3cc1dfa9f750e49288eb0f174e5807d789cf4552ea28fd59148a5885bdc2d703e2899754a7ebb08e6599fdfc43845c714c867000000000000000000000000000000000000000000000000000000000000001b00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802118c9e01000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a20ee95cbd137a9b459e382b317a6342087da4ddd9e4215fbbb69cec3fe4b82028b10012a0c08b3c2d0f70510e3f7da9c01320962616e64636861696e0074e9db581a49405c8982e3ecaa81e5ef0a7e2ebbfa72c758778c3070380de2da6ace14389fd984502d1ab1273d3f678dbb5a988ceeb4912aa9e93e776ec0c110000000000000000000000000000000000000000000000000000000000000001b00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802118c9e01000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a20ee95cbd137a9b459e382b317a6342087da4ddd9e4215fbbb69cec3fe4b82028b10012a0c08b3c2d0f70510cfd6959e01320962616e64636861696e007a45a72854b0a9a6a615c55efafc7daa6366aee86700e15f1f45e82c5644e4dc7545bdd1dd0d6b5efadd5816b400be55b61f5b9c7127be2521009f43b092112d000000000000000000000000000000000000000000000000000000000000001b00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802118c9e01000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a20ee95cbd137a9b459e382b317a6342087da4ddd9e4215fbbb69cec3fe4b82028b10012a0c08b3c2d0f70510d9fa9da001320962616e64636861696e0000000000000000000000000000000000000000000000000000000000000007800000000000000000000000000000000000000000000000000000000000019e8c00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000f8d6000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000d00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000966726f6d5f7363616e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e0000000342544300000003555344000000046d65616e0000000000000064000000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000090000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000005ef34682000000000000000000000000000000000000000000000000000000005ef3468600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000966726f6d5f7363616e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000f937a181077d74a00d1c4888d3957b673b7ac5265cef6642b398ee81564e0a02a866000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000f93792dbf6c1d5523fedfec04d0d8cf33992bc2f5a748d935cafaa022d14da11701900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000d000000000000000000000000000000000000000000000000000000000000f948bea043e9a22ced8e9149097d6f7c9c3d719280d05fcf127cb7727fdb8a5c4f7f000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000f9483be0e603fd2d50e9adff89e384c1586933110ef6320849658961f119a6fb731e000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000f948121889d461b385a0d77fa5e484f58ad580f126d307526e7ef487c6742a8da9d9000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000070000000000000000000000000000000000000000000000000000000000000039000000000000000000000000000000000000000000000000000000000000f948562e86bb47132ccc0223eea4c35ef16d0d512086a975f1b473706dd23a57135400000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000007a0000000000000000000000000000000000000000000000000000000000019e8bcc921a62033387ad80d703b9fccf04e1d501b4e7d8e006a79d9d91de032092f3",
            { from: bob },
          ),
          "FAIL_REQUEST_IS_NOT_SUCCESSFULLY_RESOLVED",
        );
      });

      it("should be able relay and consume state by consumer contract", async () => {
        // consume and fail
        await expectRevert(this.consumer.consumeCache(), "RESPONSE_NOT_FOUND");

        const {
          clientId,
          requestId,
          ansCount,
          requestTime,
          resolveTime,
          resolveStatus,
          result,
        } = await this.consumer.latestRes();

        [
          clientId,
          requestId.toString(),
          ansCount.toString(),
          requestTime.toString(),
          resolveTime.toString(),
          resolveStatus.toString(),
          result,
        ]
          .toString()
          .should.eq(["", "0", "0", "0", "0", "0", null].toString());

        // relay
        await this.cache.relay(
          "0x0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000005e00000000000000000000000000000000000000000000000000000000000000a0e5b14e631db5cdbb2c068be853242e45a091e9c178a5ca180656a12f6afde184472628869fbd308d01fcbd3411df82b10329b57df6c0c44626024e1bb0465b9486fdb04f6871c5d4bd5cb74a4c5a13a537bdd1159f7c38e797d297bc5f19770fbb1f2fd852e790e735ca2d3014f96a2a53c60393e9c6bbf941b9a6dd6a05cf6f97e9cc402179a6714d7a4e34d8ddd21e853780a131455be3cdf89760b972c4b2532fa694879095840619f5e49380612bd296ff7e950eafb66ff654d99ca70869ef5529da80f2d395d551db9bce5ae15f89dd95314ca25124ec2456cf273c56fccd44c55c16e5d04367ddc30ca19f062d7bcd995c66a9f7b7437044391946ff1aa004209a161040ab1778e2f2c00ee482f205b28efba439fcb04ea283f619478d96e340b9cffb37a989ca544e6bb780a2c78901d3fb33738768511a30617afa01d7f4be7e5a1eb872ad44103360ddc190410331280c42a54d829a5d752c796685d00000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000002e05625b835f405a26be5befe6f5f84e3078e8c4776ad18f98e746878b6770749ed44096ce96669a26351476f69665ba7ecc86372625a51fe5e6c49a8bd509169f7000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802110e0a00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a20bc2ee65d649f9ac73b1c9da9af321df3058202a8873f4547bb1558ac6e39201810012a0c08f295c8f7051090ab958701320962616e64636861696e004add47680935a19b6ec9cedd40423b6729bc989de76cfc6debe51bb5be9735c8278a48fb4cd26f8b3735646a6bd4d234c459b8e6e1543b21ef324d0d3f80999c000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802110e0a00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a20bc2ee65d649f9ac73b1c9da9af321df3058202a8873f4547bb1558ac6e39201810012a0c08f295c8f70510b5c9938301320962616e64636861696e003892a4f6e094129190e9a6626de612731333b1efd797efe3325903e63508624073f41504a93434ac2ca26e93d5a32ab40edbb870711992f20621b7d6a2f54335000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000106e0802110e0a00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f12240a20bc2ee65d649f9ac73b1c9da9af321df3058202a8873f4547bb1558ac6e39201810012a0c08f295c8f70510c2edf88301320962616e64636861696e0000000000000000000000000000000000000000000000000000000000000007a00000000000000000000000000000000000000000000000000000000000000a0e00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000007ea000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000966726f6d5f7363616e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f000000034254430000000000000064000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000005ef20816000000000000000000000000000000000000000000000000000000005ef2081a00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000966726f6d5f7363616e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000eb71b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000009b27e34da46bfd69cee4ffcbb512395fa7fa5fc7d5016aabe242f8e99cb82e806af00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000009b2bbd0ad34229408383dc3e8f4eaa1c44481ae7198a8ad5dfa234ed0559f09183c00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000009c3d15486b84f62b5535c0fd46c437489d212911d95501211f1c3a730e32f630eb600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000d00000000000000000000000000000000000000000000000000000000000009c33cdb5cc721bc11d70d6eb33377a26c387ef3c45c064916d6a36659402252ff5600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001b00000000000000000000000000000000000000000000000000000000000009c3121889d461b385a0d77fa5e484f58ad580f126d307526e7ef487c6742a8da9d900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000009c3562e86bb47132ccc0223eea4c35ef16d0d512086a975f1b473706dd23a5713540000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000a0d0920a260853246a4ffb39a139a1ac98e3590879f521e03514a38448107996c50",
          { from: bob },
        );

        // consume again
        await this.consumer.consumeCache();

        const x = await this.consumer.latestRes();

        [
          x.clientId,
          x.requestId,
          x.ansCount,
          x.requestTime,
          x.resolveTime,
          x.resolveStatus,
          x.result,
        ]
          .toString()
          .should.eq(
            [
              "from_scan",
              "3",
              "4",
              "1592920086",
              "1592920090",
              "1",
              "0x00000000000eb71b",
            ].toString(),
          );
      });
    },
  );

  context("Relay Multiple Requests", () => {
    beforeEach(async () => {
      this.templates = [
        [
          "from_scan",
          "2",
          "0x00000004474f4f4700000010324b4d43424c415a4d3554453256504700000000000003e8",
          "1",
          "1",
        ],
        [
          "from_scan",
          "2",
          "0x000000044141504c00000010324b4d43424c415a4d3554453256504700000000000003e8",
          "1",
          "1",
        ],
        [
          "from_scan",
          "2",
          "0x00000002464200000010324b4d43424c415a4d3554453256504700000000000003e8",
          "1",
          "1",
        ],
      ];

      this.bridge = await Bridge.new([
        ["0xaAA22E077492CbaD414098EBD98AA8dc1C7AE8D9", 100],
      ]);

      this.consumer = await BridgeCacheConsumerMock.new(
        this.cache.address,
        this.template,
        { from: alice },
      );
    });
  });
});
